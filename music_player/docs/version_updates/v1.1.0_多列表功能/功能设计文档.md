# 🎵 v1.1.0 - 多列表功能设计文档

**版本**: v1.1.0  
**更新日期**: 2025年8月25日  
**开发者**: lvy010  
**功能模块**: 多播放列表与喜欢列表  

---

## 📋 功能概述

### 🎯 核心功能
实现多个播放列表管理系统，支持创建、切换和管理不同类型的播放列表，提升用户音乐管理体验。

### ✨ 主要特性
1. **📚 多列表支持** - 支持创建多个独立播放列表
2. **❤️ 喜欢列表** - 专门的收藏歌曲列表
3. **🔍 搜索列表** - 基于搜索结果的动态列表
4. **🎯 拖拽排序** - 支持长按拖拽调整播放顺序
5. **🔄 播放模式** - 单曲循环、随机播放、顺序播放

---

## 🎨 UI设计规范

### 📱 界面布局
```
┌─────────────────────────────────────┐
│ ← 返回   🎵 播放列表管理    + 新建  │  ← 顶部导航
├─────────────────────────────────────┤
│ 📋 所有列表  ❤️ 喜欢  🔍 搜索      │  ← 列表切换标签
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ ≡ 歌曲1 - 艺术家1       03:45   │ │  ← 可拖拽列表项
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ ≡ 歌曲2 - 艺术家2       04:12   │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ 🔄 顺序播放  🎲 随机  🔁 单曲循环   │  ← 播放模式控制
└─────────────────────────────────────┘
```

### 🎨 视觉设计
- **标签栏**: 顶部固定，支持滑动切换
- **列表项**: 左侧拖拽图标，右侧操作菜单
- **播放模式**: 底部固定，图标+文字设计
- **动画效果**: 列表切换、拖拽反馈、模式切换

---

## 🔧 技术架构

### 📊 数据结构设计

```c
// 播放列表结构定义
typedef struct {
    char name[64];              // 列表名称
    char description[128];      // 列表描述
    char** song_paths;          // 歌曲路径数组
    album_info_t* songs;        // 歌曲信息数组
    int song_count;             // 歌曲数量
    int current_song_index;     // 当前播放索引
    int max_capacity;           // 最大容量
    bool is_favorite;           // 是否为喜欢列表
    bool is_search_result;      // 是否为搜索结果
    uint32_t created_time;      // 创建时间
    uint32_t modified_time;     // 修改时间
} playlist_t;

// 播放列表管理器
typedef struct {
    playlist_t* playlists[MAX_PLAYLISTS];  // 播放列表数组
    int playlist_count;                    // 列表数量
    int current_playlist_id;               // 当前活动列表ID
    int play_mode;                         // 播放模式
    bool shuffle_enabled;                  // 随机播放
    bool repeat_enabled;                   // 循环播放
} playlist_manager_t;

// 播放模式枚举
typedef enum {
    PLAY_MODE_SEQUENTIAL = 0,   // 顺序播放
    PLAY_MODE_SHUFFLE,          // 随机播放
    PLAY_MODE_REPEAT_ONE,       // 单曲循环
    PLAY_MODE_REPEAT_ALL        // 列表循环
} play_mode_t;
```

### 🔄 核心API设计

```c
// 播放列表管理
playlist_t* playlist_create(const char* name, const char* description);
int playlist_add_song(playlist_t* playlist, album_info_t* song);
int playlist_remove_song(playlist_t* playlist, int index);
int playlist_move_song(playlist_t* playlist, int from_index, int to_index);
void playlist_destroy(playlist_t* playlist);

// 多列表管理
int playlist_manager_add_list(playlist_t* playlist);
int playlist_manager_remove_list(int playlist_id);
int playlist_manager_switch_list(int playlist_id);
playlist_t* playlist_manager_get_current(void);

// 喜欢列表专用
int favorite_list_add_song(album_info_t* song);
int favorite_list_remove_song(int song_id);
bool favorite_list_contains_song(int song_id);

// 播放模式控制
void playlist_set_play_mode(play_mode_t mode);
int playlist_get_next_song_index(void);
int playlist_get_previous_song_index(void);
```

---

## 🎯 实现细节

### 1. 📚 多列表切换实现

```c
// 列表切换动画
static void playlist_switch_animation(int from_id, int to_id) {
    lv_anim_t anim_out, anim_in;
    
    // 当前列表淡出
    lv_anim_init(&anim_out);
    lv_anim_set_var(&anim_out, current_list_container);
    lv_anim_set_values(&anim_out, LV_OPA_COVER, LV_OPA_TRANSP);
    lv_anim_set_duration(&anim_out, 200);
    lv_anim_set_exec_cb(&anim_out, (lv_anim_exec_xcb_t)lv_obj_set_style_opa);
    
    // 新列表淡入
    lv_anim_init(&anim_in);
    lv_anim_set_var(&anim_in, new_list_container);
    lv_anim_set_values(&anim_in, LV_OPA_TRANSP, LV_OPA_COVER);
    lv_anim_set_duration(&anim_in, 200);
    lv_anim_set_delay(&anim_in, 150);
    lv_anim_set_exec_cb(&anim_in, (lv_anim_exec_xcb_t)lv_obj_set_style_opa);
    
    lv_anim_start(&anim_out);
    lv_anim_start(&anim_in);
}
```

### 2. 🎯 拖拽排序实现

```c
// 拖拽状态管理
typedef struct {
    bool is_dragging;
    int drag_source_index;
    int drag_target_index;
    lv_obj_t* drag_placeholder;
    lv_point_t drag_start_pos;
} drag_state_t;

// 拖拽事件处理
static void playlist_item_drag_handler(lv_event_t* e) {
    lv_event_code_t code = lv_event_get_code(e);
    lv_obj_t* item = lv_event_get_target(e);
    int item_index = (int)(uintptr_t)lv_event_get_user_data(e);
    
    switch (code) {
        case LV_EVENT_LONG_PRESSED:
            // 开始拖拽
            start_drag_operation(item, item_index);
            break;
            
        case LV_EVENT_PRESSING:
            // 拖拽中
            update_drag_position(e);
            break;
            
        case LV_EVENT_RELEASED:
            // 结束拖拽
            finish_drag_operation();
            break;
    }
}
```

### 3. 🔄 播放模式实现

```c
// 播放模式控制
static int get_next_song_by_mode(playlist_t* playlist, play_mode_t mode) {
    switch (mode) {
        case PLAY_MODE_SEQUENTIAL:
            return (playlist->current_song_index + 1) % playlist->song_count;
            
        case PLAY_MODE_SHUFFLE:
            return rand() % playlist->song_count;
            
        case PLAY_MODE_REPEAT_ONE:
            return playlist->current_song_index;
            
        case PLAY_MODE_REPEAT_ALL:
            return (playlist->current_song_index + 1) % playlist->song_count;
            
        default:
            return 0;
    }
}
```

---

## 📊 性能指标

### 🎯 目标性能
- **列表切换**: < 300ms
- **拖拽响应**: < 50ms
- **搜索响应**: < 200ms
- **内存占用**: 每个列表 < 5MB

### 📈 测试用例
1. **功能测试**: 创建/删除列表、添加/移除歌曲
2. **性能测试**: 大列表(1000首歌)的操作响应
3. **交互测试**: 拖拽、切换、搜索的用户体验
4. **稳定性测试**: 长时间使用的内存泄漏检查

---

## 🚀 开发计划

### 阶段1: 数据结构 (1天)
- [ ] 定义播放列表数据结构
- [ ] 实现基础CRUD操作
- [ ] 添加数据持久化

### 阶段2: UI实现 (2天)
- [ ] 创建多标签界面
- [ ] 实现列表切换动画
- [ ] 添加拖拽交互

### 阶段3: 功能集成 (1天)
- [ ] 集成播放模式控制
- [ ] 添加喜欢列表逻辑
- [ ] 完善搜索功能

### 阶段4: 测试优化 (1天)
- [ ] 性能测试和优化
- [ ] 用户体验调优
- [ ] 文档完善

---

**📝 备注**: 此功能将显著提升用户的音乐管理体验，是向专业音乐播放器迈进的重要一步。

