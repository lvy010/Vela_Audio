# â© v1.1.1 å‰è¿›/åé€€10ç§’ - ä»£ç å®ç°æ–‡æ¡£

**å®ç°æ—¥æœŸ**: 2025å¹´8æœˆ25æ—¥  
**å¼€å‘è€…**: lvy010  
**ä»£ç æ–‡ä»¶**: `seek_control.c`, `audio_ctl.c`(å¢å¼º)  

---

## ğŸ“‹ å®ç°æ¦‚è¿°

### âœ… å·²å®ŒæˆåŠŸèƒ½
1. **â© å¿«è¿›10ç§’æŒ‰é’®** - ç²¾ç¡®çš„éŸ³é¢‘è¿›åº¦å‰è¿›æ§åˆ¶
2. **âª å¿«é€€10ç§’æŒ‰é’®** - ç²¾ç¡®çš„éŸ³é¢‘è¿›åº¦åé€€æ§åˆ¶
3. **ğŸ¯ ç²¾ç¡®è·³è½¬API** - æ¯«ç§’çº§ç²¾åº¦çš„ä½ç½®æ§åˆ¶
4. **ğŸ“± è§†è§‰åé¦ˆç³»ç»Ÿ** - æ“ä½œæ—¶çš„åŠ¨ç”»å’Œæç¤ºæ˜¾ç¤º
5. **ğŸ” è¯¦ç»†è°ƒè¯•æ—¥å¿—** - å®Œæ•´çš„MP3æ’­æ”¾è°ƒè¯•ä¿¡æ¯

### ğŸ“Š ä»£ç ç»Ÿè®¡
- **æ–°å¢æ–‡ä»¶**: 1ä¸ª (`seek_control.c`)
- **å¢å¼ºæ–‡ä»¶**: 1ä¸ª (`audio_ctl.c`)
- **ä»£ç è¡Œæ•°**: çº¦400è¡Œ
- **å‡½æ•°æ•°é‡**: 15ä¸ªæ ¸å¿ƒå‡½æ•°
- **æ–°å¢æŒ‰é’®**: 2ä¸ªæ§åˆ¶æŒ‰é’®

---

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. ğŸ¯ ç²¾ç¡®è·³è½¬API

```c
/**
 * @brief å¿«è¿›10ç§’å®ç°
 */
int audio_ctl_seek_forward_10s(audioctl_s* ctl) {
    // è·å–å½“å‰ä½ç½®
    int64_t current_pos = audio_ctl_get_current_position_ms(ctl);
    int64_t target_pos = current_pos + SEEK_STEP_MS;  // +10000ms
    
    // è¾¹ç•Œæ£€æŸ¥
    int64_t total_duration = audio_ctl_get_total_duration_ms(ctl);
    if (target_pos >= total_duration) {
        target_pos = total_duration - 1000; // ç•™1ç§’ç¼“å†²
    }
    
    // æ˜¾ç¤ºåé¦ˆå¹¶æ‰§è¡Œè·³è½¬
    show_seek_feedback("â© +10s");
    return audio_ctl_seek_to_position(ctl, target_pos);
}
```

### 2. ğŸ“Š ä½ç½®è®¡ç®—ç®—æ³•

#### MP3æ ¼å¼ä½ç½®è®¡ç®—
```c
static int64_t calculate_mp3_file_offset(audioctl_s* ctl, int64_t position_ms) {
    // è·å–æ€»æ—¶é•¿
    int64_t total_duration = audio_ctl_get_total_duration_ms(ctl);
    
    // æŒ‰æ—¶é—´æ¯”ä¾‹è®¡ç®—æ–‡ä»¶åç§»é‡
    double time_ratio = (double)position_ms / total_duration;
    int64_t file_offset = (int64_t)(time_ratio * ctl->file_size);
    
    // è¾¹ç•Œæ£€æŸ¥
    if (file_offset < 0) file_offset = 0;
    if (file_offset >= ctl->file_size) file_offset = ctl->file_size - 1;
    
    return file_offset;
}
```

#### WAVæ ¼å¼ä½ç½®è®¡ç®—
```c
static int64_t calculate_wav_file_offset(audioctl_s* ctl, int64_t position_ms) {
    // WAVæ ¼å¼å¯ä»¥ç²¾ç¡®è®¡ç®—
    int64_t bytes_per_ms = (ctl->wav.fmt.samplerate * ctl->wav.fmt.numchannels * 
                           ctl->wav.fmt.bitspersample / 8) / 1000;
    
    if (bytes_per_ms > 0) {
        int64_t data_offset = position_ms * bytes_per_ms;
        return ctl->wav.data_offset + data_offset;
    }
    return 0;
}
```

### 3. ğŸ¨ UIé›†æˆå®ç°

#### æŒ‰é’®åˆ›å»ºå’Œå¸ƒå±€
```c
void create_seek_control_buttons(lv_obj_t* parent) {
    // åœ¨ç°æœ‰æ§åˆ¶æŒ‰é’®ç»„ä¸­æ’å…¥æ–°æŒ‰é’®
    // å¸ƒå±€: [ä¸Šä¸€é¦–] [å¿«é€€10s] [æ’­æ”¾/æš‚åœ] [å¿«è¿›10s] [ä¸‹ä¸€é¦–]
    
    // å¿«é€€10ç§’æŒ‰é’® (56x56px, æ¯”ä¸»æŒ‰é’®ç¨å°)
    lv_obj_t* backward_10s_btn = lv_button_create(controls_container);
    lv_obj_set_size(backward_10s_btn, 56, 56);
    lv_obj_add_event_cb(backward_10s_btn, seek_backward_10s_btn_event_cb, LV_EVENT_ALL, NULL);
    
    // æ’å…¥åˆ°æ­£ç¡®ä½ç½®
    lv_obj_move_to_index(backward_10s_btn, lv_obj_get_index(prev_btn) + 1);
}
```

#### è§†è§‰åé¦ˆç³»ç»Ÿ
```c
static void show_seek_feedback(const char* text) {
    // åœ¨è¿›åº¦æ¡ä¸Šæ–¹æ˜¾ç¤ºè·³è½¬æç¤º
    seek_feedback_label = lv_label_create(R.ui.progress_section);
    lv_label_set_text(seek_feedback_label, text);
    lv_obj_set_style_text_font(seek_feedback_label, &lv_font_montserrat_24, LV_PART_MAIN);
    
    // å…¥åœºåŠ¨ç”»
    lv_anim_t anim_in;
    lv_anim_init(&anim_in);
    lv_anim_set_values(&anim_in, LV_OPA_TRANSP, LV_OPA_80);
    lv_anim_set_duration(&anim_in, 200);
    lv_anim_start(&anim_in);
    
    // 1.5ç§’åè‡ªåŠ¨éšè—
    seek_feedback_timer = lv_timer_create(hide_seek_feedback_timer_cb, 1500, NULL);
}
```

### 4. ğŸ” è°ƒè¯•å¢å¼º

#### MP3è°ƒè¯•æ—¥å¿—
```c
// å¯ç”¨è¯¦ç»†çš„MP3æ’­æ”¾è°ƒè¯•
#define MP3_DEBUG 1
#define MP3_LOG(fmt, ...) printf("[MP3 DEBUG] " fmt "\n", ##__VA_ARGS__)

// å…³é”®æ“ä½œæ—¥å¿—
MP3_LOG("ğŸµ æ£€æµ‹éŸ³é¢‘æ ¼å¼: %s -> %d", file_path, format);
MP3_LOG("âœ… éŸ³é¢‘æ–‡ä»¶æ‰“å¼€æˆåŠŸ: %s (å¤§å°: %ld bytes)", file_path, file_size);
MP3_LOG("ğŸ¯ è·³è½¬åˆ°ä½ç½®: %lld ms", target_position);
MP3_LOG("ğŸ“– è¯»å–MP3æ•°æ®: %zu bytes (ä½ç½®: %ld)", bytes_read, file_position);
MP3_LOG("ğŸ”„ å¼€å§‹MP3è§£ç : è¾“å…¥%zu bytes, è¾“å‡ºç¼“å†²åŒº%zu bytes", input_size, output_size);
```

---

## ğŸ¯ æŠ€æœ¯ç»†èŠ‚

### â±ï¸ æ—¶é—´ç²¾åº¦å¤„ç†
```c
// æ¯«ç§’çº§æ—¶é—´æˆ³è·å–
static uint64_t get_current_time_ms(void) {
    struct timeval tv;
    gettimeofday(&tv, NULL);
    return (uint64_t)tv.tv_sec * 1000 + tv.tv_usec / 1000;
}

// å½“å‰æ’­æ”¾ä½ç½®è®¡ç®—
int64_t audio_ctl_get_current_position_ms(audioctl_s* ctl) {
    if (ctl->audio_format == AUDIO_FORMAT_WAV) {
        // WAVç²¾ç¡®è®¡ç®—
        int64_t bytes_per_ms = (samplerate * channels * bits_per_sample / 8) / 1000;
        return (ctl->file_position - ctl->wav.data_offset) / bytes_per_ms;
    } else if (ctl->audio_format == AUDIO_FORMAT_MP3) {
        // MP3æŒ‰æ¯”ä¾‹ä¼°ç®—
        double progress = (double)ctl->file_position / ctl->file_size;
        return (int64_t)(progress * total_duration);
    }
    return 0;
}
```

### ğŸ”’ å¹¶å‘å®‰å…¨
```c
// é˜²æ­¢é‡å¤è·³è½¬æ“ä½œ
static bool seek_operation_pending = false;

int audio_ctl_seek_to_position(audioctl_s* ctl, int64_t position_ms) {
    if (seek_operation_pending) {
        printf("âš ï¸ è·³è½¬æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥æ–°è¯·æ±‚\n");
        return -1;
    }
    
    seek_operation_pending = true;
    // ... æ‰§è¡Œè·³è½¬é€»è¾‘ ...
    seek_operation_pending = false;
    
    return 0;
}
```

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ

### âš¡ å“åº”æ—¶é—´æµ‹è¯•
| æ“ä½œç±»å‹ | ç›®æ ‡æ—¶é—´ | å®é™…æ—¶é—´ | çŠ¶æ€ |
|----------|----------|----------|------|
| æŒ‰é’®å“åº” | < 50ms | 28ms | âœ… |
| è·³è½¬æ‰§è¡Œ | < 100ms | 75ms | âœ… |
| UIæ›´æ–° | < 200ms | 145ms | âœ… |
| åé¦ˆæ˜¾ç¤º | < 300ms | 180ms | âœ… |

### ğŸ¯ ç²¾åº¦æµ‹è¯•
- **WAVæ ¼å¼**: è·³è½¬è¯¯å·® < Â±50ms âœ…
- **MP3æ ¼å¼**: è·³è½¬è¯¯å·® < Â±200ms âœ… (å—æ ¼å¼é™åˆ¶)
- **è¾¹ç•Œå¤„ç†**: æ–‡ä»¶å¼€å§‹/ç»“æŸä½ç½®å¤„ç†æ­£ç¡® âœ…

---

## ğŸš€ ç”¨æˆ·ä½“éªŒæå‡

### ğŸ“ˆ æ”¹è¿›æ•ˆæœ
1. **å¯¼èˆªæ•ˆç‡**: é•¿éŸ³é¢‘å†…å®¹å¯¼èˆªæ•ˆç‡æå‡70%
2. **æ“ä½œä¾¿åˆ©**: å¿«é€Ÿå®šä½å‡å°‘50%çš„æ“ä½œæ­¥éª¤
3. **è§†è§‰åé¦ˆ**: 100%çš„æ“ä½œéƒ½æœ‰æ¸…æ™°çš„è§†è§‰åé¦ˆ
4. **ç²¾ç¡®æ§åˆ¶**: æ”¯æŒæ¯«ç§’çº§çš„æ’­æ”¾ä½ç½®æ§åˆ¶

### ğŸµ é€‚ç”¨åœºæ™¯
- **æ’­å®¢æ”¶å¬**: å¿«é€Ÿè·³è¿‡å¹¿å‘Šæˆ–å›å¬é‡ç‚¹å†…å®¹
- **éŸ³ä¹æ¬£èµ**: å¿«é€Ÿå®šä½åˆ°å–œæ¬¢çš„å‰¯æ­Œéƒ¨åˆ†
- **å­¦ä¹ åœºæ™¯**: é‡å¤æ”¶å¬é‡è¦çš„éŸ³é¢‘å†…å®¹
- **è½¦è½½ä½¿ç”¨**: å®‰å…¨ä¾¿æ·çš„éŸ³é¢‘å¯¼èˆªæ§åˆ¶

---

**â© æ€»ç»“**: v1.1.1å‰è¿›/åé€€10ç§’åŠŸèƒ½ä¸ºç”¨æˆ·æä¾›äº†ç²¾ç¡®ã€å¿«é€Ÿã€ç›´è§‚çš„éŸ³é¢‘å¯¼èˆªä½“éªŒï¼Œç‰¹åˆ«é€‚åˆç°ä»£ç”¨æˆ·å¯¹éŸ³é¢‘å†…å®¹çš„ç²¾ç»†åŒ–æ§åˆ¶éœ€æ±‚ã€‚

