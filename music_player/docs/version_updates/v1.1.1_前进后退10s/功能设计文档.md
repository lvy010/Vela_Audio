# ⏩ v1.1.1 - 前进/后退10秒功能设计文档

**版本**: v1.1.1  
**更新日期**: 2025年8月25日  
**开发者**: lvy010  
**功能模块**: 音频进度控制增强  

---

## 📋 功能概述

### 🎯 核心功能
实现精确的音频进度跳转功能，支持快速前进和后退10秒，提升用户在长音频内容中的导航体验。

### ✨ 主要特性
1. **⏩ 快进10秒** - 一键跳转到当前位置+10秒
2. **⏪ 快退10秒** - 一键跳转到当前位置-10秒
3. **🎯 精确定位** - 毫秒级精度的进度控制
4. **🔄 边界处理** - 智能处理文件开始/结束边界
5. **📱 视觉反馈** - 操作时的进度条动画效果

---

## 🎨 UI设计规范

### 📱 控制按钮布局
```
┌─────────────────────────────────────┐
│           🎵 当前播放               │
│     ⏮️    ⏪10s   ⏯️   ⏩10s   ⏭️    │  ← 控制按钮组
│         上一首  后退  播放  前进  下一首 │
└─────────────────────────────────────┘
```

### 🎨 按钮设计规范
- **尺寸**: 64x64px (比其他按钮稍小)
- **颜色**: 深灰背景 + 蓝色图标
- **形状**: 圆形按钮，16px圆角
- **反馈**: 点击时缩放效果 + 颜色变化
- **间距**: 按钮间距20px

### 📊 进度显示增强
```c
// 进度条上方显示跳转提示
"⏪ -10s" 或 "⏩ +10s"
```

---

## 🔧 技术实现

### 📊 数据结构扩展

```c
// 音频控制结构扩展
typedef struct {
    // ... 现有字段 ...
    
    // 10秒跳转相关
    bool seek_pending;          // 是否有待处理的跳转
    int64_t seek_target_ms;     // 目标跳转位置(毫秒)
    int64_t last_seek_time;     // 上次跳转时间
    
    // 进度显示
    int64_t current_position_ms; // 当前播放位置(毫秒)
    int64_t total_duration_ms;   // 总时长(毫秒)
    
    // 跳转反馈
    char seek_feedback_text[32]; // 跳转反馈文字
    lv_timer_t* feedback_timer;  // 反馈显示定时器
} audioctl_s;
```

### 🎯 核心API实现

```c
/**
 * @brief 快进10秒
 */
int audio_ctl_seek_forward_10s(audioctl_s* ctl) {
    if (!ctl || ctl->state != AUDIO_CTL_STATE_START) {
        return -1;
    }
    
    int64_t target_pos = ctl->current_position_ms + 10000; // +10秒
    
    // 边界检查
    if (target_pos >= ctl->total_duration_ms) {
        target_pos = ctl->total_duration_ms - 1000; // 留1秒缓冲
    }
    
    return audio_ctl_seek_to_position(ctl, target_pos);
}

/**
 * @brief 快退10秒
 */
int audio_ctl_seek_backward_10s(audioctl_s* ctl) {
    if (!ctl || ctl->state != AUDIO_CTL_STATE_START) {
        return -1;
    }
    
    int64_t target_pos = ctl->current_position_ms - 10000; // -10秒
    
    // 边界检查
    if (target_pos < 0) {
        target_pos = 0; // 回到开始
    }
    
    return audio_ctl_seek_to_position(ctl, target_pos);
}

/**
 * @brief 精确跳转到指定位置
 */
int audio_ctl_seek_to_position(audioctl_s* ctl, int64_t position_ms) {
    if (!ctl) return -1;
    
    MP3_LOG("🎯 跳转到位置: %lld ms", position_ms);
    
    // 设置跳转标志
    ctl->seek_pending = true;
    ctl->seek_target_ms = position_ms;
    ctl->last_seek_time = get_current_time_ms();
    
    // 计算文件偏移量
    if (ctl->audio_format == AUDIO_FORMAT_MP3) {
        // MP3需要重新解码到目标位置
        ctl->seek_position = calculate_mp3_file_offset(ctl, position_ms);
    } else if (ctl->audio_format == AUDIO_FORMAT_WAV) {
        // WAV可以直接计算偏移量
        ctl->seek_position = calculate_wav_file_offset(ctl, position_ms);
    }
    
    // 更新UI反馈
    update_seek_feedback_ui(ctl, position_ms);
    
    return 0;
}
```

### 🎨 UI事件处理

```c
/**
 * @brief 快进按钮事件处理
 */
static void forward_10s_btn_event_cb(lv_event_t* e) {
    lv_event_code_t code = lv_event_get_code(e);
    
    if (code == LV_EVENT_CLICKED) {
        // 执行快进
        if (audio_ctl_seek_forward_10s(C.audio_ctl) == 0) {
            // 显示反馈动画
            show_seek_feedback("⏩ +10s");
            
            // 更新进度条
            update_progress_bar_immediately();
        }
    } else if (code == LV_EVENT_PRESSED) {
        // 按下时的视觉反馈
        lv_obj_set_style_transform_scale(lv_event_get_target(e), 95, LV_PART_MAIN);
        lv_obj_set_style_bg_color(lv_event_get_target(e), lv_color_hex(0x3B82F6), LV_PART_MAIN);
    } else if (code == LV_EVENT_RELEASED) {
        // 释放时恢复
        lv_obj_set_style_transform_scale(lv_event_get_target(e), 100, LV_PART_MAIN);
        lv_obj_set_style_bg_color(lv_event_get_target(e), lv_color_hex(0x374151), LV_PART_MAIN);
    }
}

/**
 * @brief 快退按钮事件处理
 */
static void backward_10s_btn_event_cb(lv_event_t* e) {
    lv_event_code_t code = lv_event_get_code(e);
    
    if (code == LV_EVENT_CLICKED) {
        // 执行快退
        if (audio_ctl_seek_backward_10s(C.audio_ctl) == 0) {
            // 显示反馈动画
            show_seek_feedback("⏪ -10s");
            
            // 更新进度条
            update_progress_bar_immediately();
        }
    } else if (code == LV_EVENT_PRESSED) {
        // 按下时的视觉反馈
        lv_obj_set_style_transform_scale(lv_event_get_target(e), 95, LV_PART_MAIN);
        lv_obj_set_style_bg_color(lv_event_get_target(e), lv_color_hex(0x3B82F6), LV_PART_MAIN);
    } else if (code == LV_EVENT_RELEASED) {
        // 释放时恢复
        lv_obj_set_style_transform_scale(lv_event_get_target(e), 100, LV_PART_MAIN);
        lv_obj_set_style_bg_color(lv_event_get_target(e), lv_color_hex(0x374151), LV_PART_MAIN);
    }
}
```

---

## 📊 测试用例

### ✅ 功能测试
1. **基础跳转测试**
   - 在歌曲开始、中间、结尾位置测试±10s跳转
   - 验证边界情况处理(开始前、结束后)
   
2. **格式兼容测试**
   - MP3格式的跳转精度测试
   - WAV格式的跳转精度测试
   
3. **连续操作测试**
   - 快速连续点击前进/后退按钮
   - 跳转过程中切换歌曲

### 📈 性能测试
- **响应时间**: 按钮点击到跳转完成 < 100ms
- **精度测试**: 跳转位置误差 < ±200ms
- **内存影响**: 跳转操作不增加内存占用

---

## 🔍 调试和监控

### 📝 调试日志
```c
#define SEEK_LOG(fmt, ...) printf("[SEEK] " fmt "\n", ##__VA_ARGS__)

// 关键操作日志
SEEK_LOG("🎯 用户请求跳转: %s%d秒", direction > 0 ? "+" : "", abs(direction));
SEEK_LOG("📍 当前位置: %lld ms, 目标位置: %lld ms", current_pos, target_pos);
SEEK_LOG("✅ 跳转完成，实际位置: %lld ms", actual_pos);
```

### 📊 性能监控
- 跳转操作计数
- 平均跳转时间
- 跳转精度统计

---

**🎯 总结**: 这个功能将大大提升用户在音频内容中的导航体验，特别适合播客、有声书等长音频内容的快速定位需求。

